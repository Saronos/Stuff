name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install OpenShift CLI
        uses: redhat-actions/oc-installer@v1
        with:
          # Usamos "latest" para que GitHub busque la versión que esté disponible
          oc_version: 'latest' 
      
      - name: Login to OpenShift
        run: |
          # Usamos --insecure-skip-tls-verify por si el certificado del cluster es auto-firmado
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }} --insecure-skip-tls-verify
      
      - name: Set image tag
        run: |
          echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
      
      - name: Deploy to OpenShift
        run: |
          # Intentamos actualizar la imagen. 
          # Si el deployment no existe, este paso fallará (avísame si es el caso)
          oc set image deployment/url-shortener \
            url-shortener=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --record
          
          oc rollout status deployment/url-shortener --timeout=300s
      
      - name: Verify deployment
        run: |
          ROUTE_URL=$(oc get route url-shortener -o jsonpath='{.spec.host}' || echo "Route no encontrada")
          echo "Application URL: http://$ROUTE_URL"